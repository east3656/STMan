<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>STMan!¬†‚Äî¬†STM Service Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:800px; margin:0 auto; padding:20px }
    h1 { color:#007bff }
    .form-group { margin-bottom:15px }
    input, select, button { padding:8px; margin-right:10px }
    button { background:#007bff; color:#fff; border:none; cursor:pointer }
    .status { margin-left:1em; font-style:italic }
    .line-item { margin-bottom:8px }
  </style>
</head>
<body>
  <h1>STMan!</h1>

  <!-- this one button now prompts you for your secret key -->
  <button id="refresh-api">üîÑ Refresh STM Data</button>

  <div class="form-group">
    <label>Type:</label>
    <select id="schedule-type">
      <option value="bus">Bus</option>
      <option value="metro">Metro</option>
    </select>

    <label>Line Number:</label>
    <input id="schedule-number" placeholder="e.g. 139 or Green">
    <button id="add-schedule">‚ûï Add Line</button>
  </div>

  <h2>Your Saved Lines</h2>
  <div id="schedules-container"></div>
  <button id="check-status">‚úÖ Check All Statuses</button>

  <script>
    let apiPayload = null;
    let routesMap  = {};   // route ‚Üí latest status text
    let userSchedules = JSON.parse(localStorage.getItem('stmLines') || '[]');

    const scheduleTypeSelect = document.getElementById('schedule-type');
    const scheduleNumberInput= document.getElementById('schedule-number');
    const addScheduleButton  = document.getElementById('add-schedule');
    const schedulesContainer = document.getElementById('schedules-container');
    const checkStatusButton  = document.getElementById('check-status');
    const refreshApiButton   = document.getElementById('refresh-api');

    function saveUserSchedules() {
      localStorage.setItem('stmLines', JSON.stringify(userSchedules));
    }

    function displayUserSchedules() {
      schedulesContainer.innerHTML = '';
      if (!userSchedules.length) {
        schedulesContainer.innerHTML = '<p>No lines saved yet.</p>';
        return;
      }
      userSchedules.forEach((line, idx) => {
        const div = document.createElement('div');
        div.className = 'line-item';
        const text = `<strong>${line.type.toUpperCase()}</strong>¬†${line.number}
                      <span class="status">${line.status || 'Unknown'}</span>`;
        div.innerHTML = text + ` <button data-idx="${idx}" class="remove-btn">‚úñÔ∏è</button>`;
        schedulesContainer.append(div);
      });
      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.onclick = () => {
          userSchedules.splice(+btn.dataset.idx, 1);
          saveUserSchedules();
          displayUserSchedules();
        };
      });
    }

    function isValidLine(num) {
      return Boolean(routesMap[num]);
    }

    addScheduleButton.onclick = () => {
      const type = scheduleTypeSelect.value;
      const num  = scheduleNumberInput.value.trim();
      if (!num) return alert('Enter a line number');
      if (!isValidLine(num)) return alert('That line isn‚Äôt in today‚Äôs STM feed');
      userSchedules.push({ type, number: num, status: 'Not checked yet' });
      saveUserSchedules();
      displayUserSchedules();
      scheduleNumberInput.value = '';
    };

    async function refreshSTMData() {
      const secret = prompt('Enter your secret key:');
      if (!secret) return;

      try {
        const res = await fetch(`/api/valid-lines?key=${encodeURIComponent(secret)}`);
        if (res.status === 401) {
          return alert('‚ùå Unauthorized: wrong key');
        }
        if (!res.ok) {
          console.error('HTTP error', res.status);
          return alert('Error fetching STM data');
        }
        apiPayload = await res.json();

        // rebuild our route‚Üístatus map
        routesMap = {};
        apiPayload.alerts.forEach(alert => {
          const r = (alert.informed_entities || [])
                    .find(e => e.route_short_name)?.route_short_name;
          const desc = (alert.description_texts || [])
                       .find(d => d.language === 'en')?.text || '';
          if (r) routesMap[r] = desc.replace(/\n/g, '<br>');
        });

        console.log('Loaded routes:', Object.keys(routesMap).length);
        alert('‚úÖ STM data refreshed!');
      } catch (err) {
        console.error(err);
        alert('Network or server error');
      }
    }

    function checkStatus() {
      userSchedules.forEach(line => {
        line.status = routesMap[line.number] || 'No update';
      });
      saveUserSchedules();
      displayUserSchedules();
    }

    refreshApiButton.onclick = refreshSTMData;
    checkStatusButton.onclick = checkStatus;

    // page init
    displayUserSchedules();
  </script>
</body>
</html>
