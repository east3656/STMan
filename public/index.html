<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STM Service Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #007bff;
            position: relative;
            display: inline-block;
            padding-bottom: 0.25em;
        }
        h1::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 100%;
            height: 4px;
            background: #00d4ff;
            border-radius: 2px;
        }

        .metro-lines {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .metro-line {
            flex: 1;
            padding: 1rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        #yellow  { background-color: #FDD835; color: #333; }
        #blue    { background-color: #1976D2; }
        #orange  { background-color: #FF9800; }
        #green   { background-color: #43A047; }
        .metro-line .status {
            margin-top: 0.5rem;
            font-style: italic;
            font-weight: 400;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 15px;
        }
        input, button {
            padding: 8px;
            margin-right: 10px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        .line-item {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.1s ease-in-out;
        }
        .line-item:hover { transform: translateY(-2px); }
        .remove-button {
            background: #e74c3c;
            padding: 6px 10px;
            border-radius: 4px;
        }
        .remove-button:hover { background: #c0392b; }

    </style>
</head>
<body>
    <h1>STMan!</h1>

    <h2>Current Metro Status</h2>
    <div class="metro-lines">
      <div id="yellow" class="metro-line">Yellow Line<br><span class="status">â€”</span></div>
      <div id="blue"   class="metro-line">Blue Line<br><span class="status">â€”</span></div>
      <div id="orange" class="metro-line">Orange Line<br><span class="status">â€”</span></div>
      <div id="green"  class="metro-line">Green Line<br><span class="status">â€”</span></div>
    </div>

    <div class="form-group">
        <label for="schedule-number">Line Number:</label>
        <input type="text" id="schedule-number" placeholder="e.g. 139 or 161">
        <button id="add-schedule">Add Line</button>
    </div>

    <h2>Your Saved Lines</h2>
    <div id="schedules-container"></div>
    <button id="check-status">Check All Statuses</button>
    <button id="refresh-api">ðŸ”„ Refresh STM Data</button>

    <script>
        let routes = {};
        let userSchedules = JSON.parse(localStorage.getItem('stmLines') || '[]');

        const scheduleNumberInput = document.getElementById('schedule-number');
        const addScheduleButton  = document.getElementById('add-schedule');
        const schedulesContainer = document.getElementById('schedules-container');
        const checkStatusButton  = document.getElementById('check-status');
        const refreshApiButton   = document.getElementById('refresh-api');

        function saveUserSchedules() {
            localStorage.setItem('stmLines', JSON.stringify(userSchedules));
        }
        function displayUserSchedules() {
            schedulesContainer.innerHTML = '';
            if (!userSchedules.length) {
                schedulesContainer.innerHTML = '<p>No lines saved yet.</p>';
                return;
            }
            userSchedules.forEach((line, idx) => {
                const div = document.createElement('div');
                div.className = 'line-item';
                const status = line.status || 'Unknown';
                div.innerHTML = `<span><strong>${line.number}</strong> â€” <em>${status}</em></span>
                                 <button class="remove-button" data-idx="${idx}">Remove</button>`;
                schedulesContainer.appendChild(div);
            });
            document.querySelectorAll('.remove-button').forEach(btn => {
                btn.onclick = () => {
                    userSchedules.splice(+btn.dataset.idx, 1);
                    saveUserSchedules();
                    displayUserSchedules();
                };
            });
        }

        function isDuplicate(num) {
            return userSchedules.some(item => item.number === num);
        }

        addScheduleButton.onclick = () => {
            const num = scheduleNumberInput.value.trim();
            if (!num) return alert('Enter a line number');
            if (isDuplicate(num)) return alert(`${num} already added`);
            if (!routes[num]) return alert('That line isnâ€™t in todayâ€™s STM feed');
            userSchedules.push({ number: num, status: 'Not checked yet' });
            saveUserSchedules(); displayUserSchedules();
            scheduleNumberInput.value = '';
        };

        async function refreshSTMData() {
            try {
                const res = await fetch('/api/valid-lines');
                if (!res.ok) throw new Error(res.status);
                const data = await res.json();
                // build routes map
                routes = {};
                data.alerts.forEach(alert => {
                    const rt = (alert.informed_entities||[]).find(e=>e.route_short_name)?.route_short_name;
                    const txt = (alert.description_texts||[]).find(d=>d.language==='en')?.text||'';
                    if (rt) routes[rt] = txt;
                });
                updateMetroCards();
                alert('STM data refreshed!');
            } catch(e) {
                console.error(e);
                alert('Failed to fetch STM data');
            }
        }
        
        function updateMetroCards() {
            const metroMap = { yellow:'4', blue:'5', orange:'2', green:'1' };
            Object.entries(metroMap).forEach(([color, num]) => {
                const el = document.getElementById(color).querySelector('.status');
                el.textContent = routes[num] || 'No data';
            });
        }

        checkStatusButton.onclick = () => {
            userSchedules.forEach(line => {
                line.status = routes[line.number] || 'No update';
            });
            saveUserSchedules(); displayUserSchedules();
        };

        refreshApiButton.onclick = refreshSTMData;

        // init
        displayUserSchedules();
        refreshSTMData();
    </script>
</body>
</html>
