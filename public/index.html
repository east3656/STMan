<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>STMan!¬†‚Äî¬†STM Service Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:800px; margin:0 auto; padding:20px }
    h1 { color:#007bff }
    .form-group { margin-bottom:15px }
    input, select, button { padding:8px; margin-right:10px }
    button { background:#007bff; color:#fff; border:none; cursor:pointer }
    .status { margin-left:1em; font-style:italic }
    .line-item { margin-bottom:8px }
  </style>
</head>
<body>
  <h1>STMan!</h1>

  <!-- 1) fetch & cache the STM feed (secret‚Äëprotected) -->
  <button id="refresh-api">üîÑ Refresh STM Data</button>

  <!-- 2) add a line to your ‚Äúwatch list‚Äù -->
  <div class="form-group">
    <label>Type:</label>
    <select id="schedule-type">
      <option value="bus">Bus</option>
      <option value="metro">Metro</option>
    </select>

    <label>Line Number:</label>
    <input id="schedule-number" placeholder="e.g. 139 or Green">
    <button id="add-schedule">‚ûï Add Line</button>
  </div>

  <!-- 3) show your saved lines & allow status checks -->
  <h2>Your Saved Lines</h2>
  <div id="schedules-container"></div>
  <button id="check-status">‚úÖ Check All Statuses</button>

  <script>
    // globals
    let apiPayload = null;
    let routesMap  = {};             
    let userSchedules = JSON.parse(localStorage.getItem('stmLines') || '[]');

    // DOM refs
    const selType   = document.getElementById('schedule-type');
    const inpNumber = document.getElementById('schedule-number');
    const btnAdd    = document.getElementById('add-schedule');
    const container = document.getElementById('schedules-container');
    const btnCheck  = document.getElementById('check-status');
    const btnRefresh= document.getElementById('refresh-api');

    function saveUserSchedules() {
      localStorage.setItem('stmLines', JSON.stringify(userSchedules));
    }

    function displayUserSchedules() {
      container.innerHTML = '';
      if (!userSchedules.length) {
        return (container.innerHTML = '<p>No lines saved yet.</p>');
      }
      userSchedules.forEach((line, i) => {
        const div = document.createElement('div');
        div.className = 'line-item';
        const statusHTML = line.status || 'Unknown';
        div.innerHTML = `
          <strong>${line.type.toUpperCase()}</strong>¬†${line.number}
          <span class="status">${statusHTML}</span>
          <button data-idx="${i}" class="remove-btn">‚úñÔ∏è</button>
        `;
        container.append(div);
      });
      container.querySelectorAll('.remove-btn').forEach(btn => {
        btn.onclick = () => {
          userSchedules.splice(+btn.dataset.idx, 1);
          saveUserSchedules();
          displayUserSchedules();
        };
      });
    }

    function isValidLine(num) {
      return Boolean(routesMap[num]);
    }

    btnAdd.onclick = () => {
      const type = selType.value;
      const num  = inpNumber.value.trim();
      if (!num) {
        return alert('Please enter a line number');
      }
      if (!routesMap) {
        return alert('Please refresh STM data first');
      }
      if (!isValidLine(num)) {
        return alert(`${num} isn‚Äôt in today‚Äôs STM feed`);
      }
      userSchedules.push({ type, number: num, status: 'Not checked yet' });
      saveUserSchedules();
      displayUserSchedules();
      inpNumber.value = '';
    };

    async function refreshSTMData() {
      const secret = prompt('Enter your secret key:');
      if (!secret) return;
      try {
        const res = await fetch(`/api/lines?key=${encodeURIComponent(secret)}`);
        if (res.status === 401) {
          return alert('‚ùå Unauthorized: wrong key');
        }
        if (!res.ok) {
          console.error('Fetch error', res.status);
          return alert('Error fetching STM data');
        }
        apiPayload = await res.json();

        // rebuild route‚Üístatus map
        routesMap = {};
        apiPayload.alerts.forEach(a => {
          const routeEnt = (a.informed_entities||[])
                           .find(e => e.route_short_name);
          const route = routeEnt?.route_short_name;
          const descEnt = (a.description_texts||[])
                          .find(d => d.language==='en');
          const txt = descEnt?.text?.replace(/\n/g,'<br>')||'';
          if (route) routesMap[route] = txt;
        });

        console.log('Routes loaded:', Object.keys(routesMap));
        alert('‚úÖ STM data refreshed!');
      } catch (err) {
        console.error(err);
        alert('Network or server error');
      }
    }

    function checkStatus() {
      userSchedules.forEach(line => {
        line.status = routesMap[line.number] || 'No update';
      });
      saveUserSchedules();
      displayUserSchedules();
    }

    // wire up
    btnRefresh.onclick = refreshSTMData;
    btnCheck.onclick   = checkStatus;

    // init UI
    displayUserSchedules();
  </script>
</body>
</html>
