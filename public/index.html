<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>STMan! ‚Äî STM Service Tracker</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-OERcA2D2wkC1u5mVhXQ2VHNfKZQkN5qFc3q+62+snhCu4U2eFd9L/kp0tW1JXjmp"
    crossorigin="anonymous"
  />
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-primary mb-4">STMan!</h1>

    <!-- Refresh button -->
    <div class="mb-4">
      <button id="refresh-api" class="btn btn-outline-primary">
        üîÑ Refresh STM Data
      </button>
    </div>

    <!-- Add‚Äëline form -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row gx-2 gy-3 align-items-center">
          <div class="col-auto">
            <select id="schedule-type" class="form-select">
              <option value="bus">Bus</option>
              <option value="metro">Metro</option>
            </select>
          </div>
          <div class="col">
            <input
              id="schedule-number"
              type="text"
              class="form-control"
              placeholder="e.g. 139 or Green"
            />
          </div>
          <div class="col-auto">
            <button id="add-schedule" class="btn btn-success">
              ‚ûï Add Line
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Saved schedules -->
    <h2 class="h5 mb-3">Your Saved Bus/Subway Schedules</h2>
    <div id="schedules-container" class="list-group mb-3"></div>
    <button id="check-status" class="btn btn-primary">‚úÖ Check All Statuses</button>
  </div>

  <!-- Bootstrap JS Bundle (optional) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-4cm0C10+/QbwwlBVqe40plmCQxQJTJ5v1IcxmgM+eJRb0V6jei+S7domH5eOmB2B"
    crossorigin="anonymous"
  ></script>

  <!-- YOUR EXISTING SCRIPT -->
  <script>
    let apiResponse = null; 
    let routes = {};
    let userSchedules = JSON.parse(localStorage.getItem('stmLines')) || [];
    
    const scheduleTypeSelect = document.getElementById('schedule-type');
    const scheduleNumberInput = document.getElementById('schedule-number');
    const addScheduleButton = document.getElementById('add-schedule');
    const schedulesContainer = document.getElementById('schedules-container');
    const checkStatusButton = document.getElementById('check-status');
    
    function displayUserSchedules() {
      schedulesContainer.innerHTML = '';
      if (!userSchedules.length) {
        schedulesContainer.innerHTML = '<div class="list-group-item">No lines saved yet. Add some above!</div>';
        return;
      }
      userSchedules.forEach((line, index) => {
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.innerHTML = `
          <div>
            <strong>${line.type.toUpperCase()}</strong>: ${line.number}
            <span class="ms-3 fst-italic">${line.status || 'Unknown'}</span>
          </div>
          <button class="btn btn-sm btn-outline-danger remove-button" data-index="${index}">‚úñÔ∏è</button>
        `;
        schedulesContainer.append(item);
      });
      document.querySelectorAll('.remove-button').forEach(btn => {
        btn.addEventListener('click', () => {
          userSchedules.splice(+btn.dataset.index, 1);
          saveUserSchedules();
          displayUserSchedules();
        });
      });
    }
    function saveUserSchedules() {
      localStorage.setItem('stmLines', JSON.stringify(userSchedules));
    }
    function isValidStop(num) {
      return num in routes;
    }
    addScheduleButton.addEventListener('click', () => {
      const scheduleType = scheduleTypeSelect.value;
      const scheduleNumber = scheduleNumberInput.value.trim();
      if (!scheduleNumber) return alert('Please enter a line number');
      if (!isValidStop(scheduleNumber)) return alert('That line isn‚Äôt in today‚Äôs STM feed');
      userSchedules.push({ type: scheduleType, number: scheduleNumber, status: 'Not checked yet' });
      saveUserSchedules();
      displayUserSchedules();
      scheduleNumberInput.value = '';
    });

    async function refreshSTMData() {
      try {
        const response = await fetch('/api/valid-lines');
        if (!response.ok) {
          console.error('HTTP error:', response.status);
          return alert('Error fetching STM data');
        }
        apiResponse = await response.json();
        routes = {};
        apiResponse.alerts.forEach(alert => {
          const routeEnt = (alert.informed_entities || []).find(e => e.route_short_name != null);
          if (!routeEnt) return;
          const route = routeEnt.route_short_name;
          const descEnt = (alert.description_texts || []).find(d => d.language === 'en');
          routes[route] = descEnt ? descEnt.text : '';
        });
        console.log('STM API Data:', apiResponse);
      } catch (error) {
        console.error('Error fetching STM API data:', error);
        alert('Refresh failed');
      }
    }

    function checkStatus() {
      userSchedules.forEach(line => {
        line.status = routes[line.number] || 'No update';
      });
      saveUserSchedules();
      displayUserSchedules();
    }

    // wire up buttons & init
    displayUserSchedules();
    document.getElementById('refresh-api').addEventListener('click', refreshSTMData);
    checkStatusButton.addEventListener('click', checkStatus);
    refreshSTMData();
  </script>
</body>
</html>
